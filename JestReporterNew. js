const fs = require("fs");
const path = require("path");

class CustomJestReporter {
  constructor(globalConfig, options) {
    this.output = options.output || "jest-results.json";
    this.results = [];
    this.testCounters = {};
  }

  // Strip params without regex
  cleanName(title) {
    if (!title) return "";

    const cutChars = ["{", "[", "(", "=", ":"];
    let minIndex = title.length;

    for (const ch of cutChars) {
      const idx = title.indexOf(ch);
      if (idx !== -1 && idx < minIndex) {
        minIndex = idx;
      }
    }

    return title.substring(0, minIndex).trim();
  }

  onTestResult(test, testResult) {
    const file = path.relative(process.cwd(), testResult.testFilePath);

    if (!this.testCounters[file]) {
      this.testCounters[file] = 1;
    }

    for (let i = 0; i < testResult.testResults.length; i++) {
      const entry = testResult.testResults[i];
      const testIndex = this.testCounters[file]++;

      // STABLE UNIQUE ID
      const id = `${file}::test-${String(testIndex).padStart(3, "0")}`;

      // CLEAN HUMAN TITLE
      const cleanTitle = this.cleanName(entry.title);

      this.results.push({
        id,
        name: cleanTitle,
        status: entry.status
      });
    }
  }

  onRunComplete() {
    fs.writeFileSync(this.output, JSON.stringify(this.results, null, 2));
  }
}

module.exports = CustomJestReporter;