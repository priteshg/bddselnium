const fs = require("fs");
const path = require("path");

class CustomJestReporter {
  constructor(globalConfig, options) {
    this.output = options.output || "jest-results.json";
    this.results = [];
    this.testCounters = {}; // file â†’ index
  }

  onTestResult(test, testResult) {
    const file = path.relative(process.cwd(), testResult.testFilePath);

    if (!this.testCounters[file]) {
      this.testCounters[file] = 1;
    }

    for (let i = 0; i < testResult.testResults.length; i++) {
      const testIndex = this.testCounters[file]++;

      // Stable unique ID for this test
      const id = `${file}::test-${String(testIndex).padStart(3, "0")}`;

      this.results.push({
        id,
        status: testResult.testResults[i].status
      });
    }
  }

  onRunComplete() {
    fs.writeFileSync(this.output, JSON.stringify(this.results, null, 2));
  }
}

module.exports = CustomJestReporter;