import { test as base } from 'playwright-bdd';
import type { Page } from '@playwright/test';
import { xxx, xxx } from '../utils/setup';
import {
  AppControl,
  Filters,
  Message,
  MessageList,
  Search,
  SearchCriteriaModal,
  GarageDoor,
} from '../pages';
import type { UserCredentials } from '../pages/login';
import { MyArchive } from '../pages/myArchive';

type Fixtures = {
  credentials: UserCredentials;

  grApp: xxx;

  myArchive: MyArchive;
  filters: Filters;
  message: Message;
  messageList: MessageList;
  search: Search;
  searchCriteriaModal: SearchCriteriaModal;
  garageDoor: GarageDoor;

  resetApp: void;
  teardown: void;
};

export const test = base.extend<Fixtures>({
  // keep your existing credentials fixture or import it from where it lives today
  credentials: async ({}, use) => {
    await use({} as UserCredentials);
  },

  // change: worker scope
  grApp: [
    async ({ credentials }, use, testInfo) => {
      const grApp = await loadGlobalRelayApp(0, credentials, testInfo);
      await new AppControl(grApp.frame).selectMyArchive();

      await use(grApp);

      await grApp.electronApp.close();
    },
    { scope: 'worker' },
  ],

  // new: per test reset
  resetApp: async ({ grApp }, use) => {
    const page = await grApp.electronApp.firstWindow();
    await resetRenderer(page);
    await use();
  },

  // keep existing page object fixtures
  myArchive: async ({ grApp }, use) => {
    await use(new MyArchive(grApp.frame));
  },
  filters: async ({ grApp }, use) => {
    await use(new Filters(grApp.frame));
  },
  message: async ({ grApp }, use) => {
    await use(new Message(grApp.frame));
  },
  messageList: async ({ grApp }, use) => {
    await use(new MessageList(grApp.frame));
  },
  search: async ({ grApp }, use) => {
    await use(new Search(grApp.frame));
  },
  searchCriteriaModal: async ({ grApp }, use) => {
    await use(new SearchCriteriaModal(grApp.frame));
  },
  garageDoor: async ({ grApp }, use) => {
    await use(new GarageDoor(grApp.frame));
  },

  // keep teardown, no reload in here
  teardown: async ({ grApp }, use, testInfo) => {
    await use();

    if (testInfo.status !== testInfo.expectedStatus) {
      await grApp.frame.page().screenshot({
        path: `./test-results/${testInfo.title}.png`,
        fullPage: true,
      });
      // keep your video rename, diff copy, etc here
    }
  },
});

async function resetRenderer(page: Page) {
  // optional
  await page.evaluate(() => {
    localStorage.clear();
    sessionStorage.clear();
  });

  await page.reload({ waitUntil: 'domcontentloaded' });

  // pick a selector that proves the app is usable
  await page.waitForSelector('[data-testid="my-archive-root"]', { state: 'visible' });
}