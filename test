import { test as base } from 'playwright-bdd';
import type { Page } from '@playwright/test';
import { AppControl, Filters, Message, MessageList, Search, SearchCriteriaModal, GarageDoor } from '../pages';
import type { UserCredentials } from '../pages/login';
import { MyArchive } from '../pages/myArchive';
import type { GlobalRelayApp } from '../utils/setup';
import { getOrStartApp, stopApp } from '../utils/electronSingleton';

type Fixtures = {
  credentials: UserCredentials;
  grApp: GlobalRelayApp;

  myArchive: MyArchive;
  filters: Filters;
  message: Message;
  messageList: MessageList;
  search: Search;
  searchCriteriaModal: SearchCriteriaModal;
  garageDoor: GarageDoor;

  resetApp: void;
  teardown: void;
};

export const test = base.extend<Fixtures>({
  credentials: async ({}, use) => {
    await use({} as UserCredentials);
  },

  grApp: async ({ credentials }, use, testInfo) => {
    const grApp = await getOrStartApp(credentials, testInfo);

    // run this once only, if needed
    // you can guard with a flag on singleton if you need
    await new AppControl(grApp.frame).selectMyArchive();

    await use(grApp);
  },

  resetApp: async ({ grApp }, use) => {
    const page = await grApp.electronApp.firstWindow();
    await resetRenderer(page);
    await use();
  },

  myArchive: async ({ grApp }, use) => {
    await use(new MyArchive(grApp.frame));
  },
  filters: async ({ grApp }, use) => {
    await use(new Filters(grApp.frame));
  },
  message: async ({ grApp }, use) => {
    await use(new Message(grApp.frame));
  },
  messageList: async ({ grApp }, use) => {
    await use(new MessageList(grApp.frame));
  },
  search: async ({ grApp }, use) => {
    await use(new Search(grApp.frame));
  },
  searchCriteriaModal: async ({ grApp }, use) => {
    await use(new SearchCriteriaModal(grApp.frame));
  },
  garageDoor: async ({ grApp }, use) => {
    await use(new GarageDoor(grApp.frame));
  },

  teardown: async ({ grApp }, use, testInfo) => {
    await use();

    if (testInfo.status !== testInfo.expectedStatus) {
      await grApp.frame.page().screenshot({
        path: `./test-results/${testInfo.title}.png`,
        fullPage: true,
      });
    }
  },
});

// Close once when the whole run finishes.
// Playwright Test supports afterAll per file. Put this in a globalSetup if you have one.
// If you do not have globalSetup, leave stopApp unused and close manually in CI.
export async function closeElectronOnce() {
  await stopApp();
}

async function resetRenderer(page: Page) {
  await page.evaluate(() => {
    localStorage.clear();
    sessionStorage.clear();
  });

  await page.reload({ waitUntil: 'domcontentloaded' });

  await page.waitForSelector('[data-testid="my-archive-root"]', { state: 'visible' });
}