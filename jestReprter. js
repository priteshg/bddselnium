import crypto from "crypto"
import { writeFileSync } from "fs"
import { relative } from "path"
import type {
  AggregatedResult,
  Reporter,
  Test,
  TestResult
} from "@jest/reporters"

type ReporterOptions = {
  outputFile?: string
}

type Status = "passed" | "failed" | "skipped" | "unknown"

type OutputRow = {
  id: string
  name: string
  status: Status
  file: string
  durationMs: number
  errorMessage: string
}

function toSafeString(value: unknown): string {
  if (typeof value === "string") {
    return value
  }

  if (value === null || value === undefined) {
    return ""
  }

  return JSON.stringify(value)
}

function normaliseStatus(value: unknown): Status {
  const statusText = toSafeString(value).toLowerCase()

  if (statusText === "passed") return "passed"
  if (statusText === "failed") return "failed"
  if (statusText === "skipped") return "skipped"
  if (statusText === "skipping") return "skipped"
  if (statusText === "todo") return "skipped"
  if (statusText === "disabled") return "skipped"

  return "unknown"
}

function pickFirstFailureMessage(entry: { failureMessages?: unknown }): string {
  const messages = entry.failureMessages

  if (!Array.isArray(messages)) {
    return ""
  }

  if (messages.length === 0) {
    return ""
  }

  return toSafeString(messages[0])
}

function stableHash(value: string): string {
  return crypto.createHash("sha1").update(value).digest("hex").slice(0, 10)
}

function cleanTestName(raw: string): string {
  return raw.replace(/\s+/g, " ").trim()
}

export default class JestCustomReporter implements Reporter {
  private readonly outputFile: string
  private readonly results: OutputRow[] = []
  private readonly testCounters: Record<string, number> = {}

  constructor(_: unknown, options: ReporterOptions) {
    this.outputFile = options.outputFile || "jest-report.json"
  }

  onTestResult(test: Test, testResult: TestResult): void {
    const relativeFile = relative(process.cwd(), testResult.testFilePath)

    if (!this.testCounters[relativeFile]) {
      this.testCounters[relativeFile] = 1
    }

    for (const assertion of testResult.testResults) {
      const index = this.testCounters[relativeFile]
      const id = `${relativeFile}::test-${String(index).padStart(3, "0")}`
      const name = cleanTestName(assertion.title)
      const status = normaliseStatus(assertion.status)
      const durationMs = assertion.duration || 0
      const errorMessage = pickFirstFailureMessage(assertion)

      this.results.push({
        id,
        name,
        status,
        file: relativeFile,
        durationMs,
        errorMessage
      })

      this.testCounters[relativeFile] += 1
    }
  }

  onRunComplete(_: unknown, __: AggregatedResult): void {
    writeFileSync(this.outputFile, JSON.stringify(this.results, null, 2))
  }
}