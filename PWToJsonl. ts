// tools/jsonl/playwright-to-jsonl.ts

import fs from "fs"
import path from "path"
import crypto from "crypto"

type Status = "passed" | "failed" | "skipped" | "unknown"

type PlaywrightEvent = {
  test_id: string
  tool: "playwright"
  status: Status
  duration_ms: number
  timestamp_utc: string
  test_name: string
  test_path: string
  error_message: string
}

type PlaywrightError = {
  message?: string
  value?: string
}

type PlaywrightResult = {
  status?: string
  outcome?: string
  duration?: number
  error?: PlaywrightError
  errors?: PlaywrightError[]
}

type PlaywrightTest = {
  title?: string
  results?: PlaywrightResult[]
}

type PlaywrightSpec = {
  title?: string
  file?: string
  tests?: PlaywrightTest[]
}

type PlaywrightSuite = {
  specs?: PlaywrightSpec[]
  suites?: PlaywrightSuite[]
}

type PlaywrightJsonReport = {
  suites?: PlaywrightSuite[]
}

function hashId(input: string): string {
  return crypto.createHash("sha1").update(input).digest("hex").slice(0, 10)
}

function ensureParentDir(filePath: string): void {
  fs.mkdirSync(path.dirname(filePath), { recursive: true })
}

function asString(value: unknown): string {
  if (value === null || value === undefined) return ""
  return String(value)
}

function toStatus(result: PlaywrightResult | undefined): Status {
  const raw = asString(result?.outcome || result?.status)

  if (raw === "expected" || raw === "passed") return "passed"
  if (raw === "skipped") return "skipped"
  if (raw === "unexpected" || raw === "failed" || raw === "timedOut") return "failed"
  if (raw === "flaky") return "failed"

  return "unknown"
}

function errorMessageFrom(result: PlaywrightResult | undefined): string {
  const direct = asString(result?.error?.message)
  if (direct) return direct.slice(0, 800)

  const errors = Array.isArray(result?.errors) ? result.errors : []
  if (!errors.length) return ""

  const first = errors[0]
  return asString(first?.message || first?.value).slice(0, 800)
}

function walkSuites(suites: PlaywrightSuite[], onSpec: (spec: PlaywrightSpec) => void): void {
  for (const suite of suites) {
    const specs = Array.isArray(suite.specs) ? suite.specs : []
    for (const spec of specs) onSpec(spec)

    const children = Array.isArray(suite.suites) ? suite.suites : []
    if (children.length) walkSuites(children, onSpec)
  }
}

function writeJsonl(filePath: string, events: PlaywrightEvent[]): void {
  fs.writeFileSync(filePath, events.map((e) => JSON.stringify(e)).join("\n") + "\n", "utf8")
}

function main(): void {
  const inputPath = process.argv[2] || "test-results/playwright-report.json"
  const outputPath = process.argv[3] || "test-results/playwright-events.jsonl"

  const report = JSON.parse(fs.readFileSync(inputPath, "utf8")) as PlaywrightJsonReport
  const timestampUtc = new Date().toISOString()

  const events: PlaywrightEvent[] = []
  const rootSuites = Array.isArray(report.suites) ? report.suites : []

  walkSuites(rootSuites, (spec) => {
    const testPath = asString(spec.file)
    const specTitle = asString(spec.title)

    const tests = Array.isArray(spec.tests) ? spec.tests : []
    for (const test of tests) {
      const testTitle = asString(test.title)
      const testName = [specTitle, testTitle].filter(Boolean).join(" ").trim()

      const results: PlaywrightResult[] = Array.isArray(test.results) ? test.results : []
      const lastResult = results.length ? results[results.length - 1] : undefined

      const status = toStatus(lastResult)
      const durationMs = typeof lastResult?.duration === "number" ? lastResult.duration : 0
      const errorMessage = errorMessageFrom(lastResult)

      events.push({
        test_id: hashId(`${testPath}::${testName}`),
        tool: "playwright",
        status,
        duration_ms: durationMs,
        timestamp_utc: timestampUtc,
        test_name: testName,
        test_path: testPath,
        error_message: errorMessage
      })
    }
  })

  ensureParentDir(outputPath)
  writeJsonl(outputPath, events)

  // eslint-disable-next-line no-console
  console.log(`Wrote ${events.length} Playwright events to ${outputPath}`)
}

main()