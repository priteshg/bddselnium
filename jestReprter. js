import crypto from "crypto"
import { writeFileSync } from "fs"
import { relative } from "path"

type Status = "passed" | "failed" | "skipped" | "unknown"

type OutputRow = {
  id: string
  name: string
  status: Status
  file: string
  durationMs: number
  errorMessage: string
}

type ReporterOptions = {
  outputFile?: string
}

function asText(value: unknown): string {
  return typeof value === "string" ? value : String(value ?? "")
}

function normaliseStatus(value: unknown): Status {
  const s = asText(value)
  if (s === "passed") return "passed"
  if (s === "failed") return "failed"
  if (s === "skipped") return "skipped"
  if (s === "skipping") return "skipped"
  if (s === "todo") return "skipped"
  if (s === "disabled") return "skipped"
  return "unknown"
}

function stableHash(value: string): string {
  return crypto.createHash("sha1").update(value).digest("hex").slice(0, 10)
}

function cleanName(raw: string): string {
  return raw.replace(/\s*\(.*?\)\s*/g, "").trim()
}

export default class CustomJestReporter {
  private output: string
  private rows: OutputRow[] = []
  private counters: Record<string, number> = {}

  constructor(_: unknown, options: ReporterOptions = {}) {
    this.output = options.outputFile ?? "jest-report.json"
  }

  onTestResult(_: unknown, testResult: any) {
    const file = relative(process.cwd(), testResult.testFilePath)

    if (!this.counters[file]) {
      this.counters[file] = 1
    }

    for (const test of testResult.testResults) {
      const index = this.counters[file]
      const id = `${file}::test-${String(index).padStart(3, "0")}`
      const name = cleanName(test.title)

      this.rows.push({
        id,
        name,
        status: normaliseStatus(test.status),
        file,
        durationMs: Number(test.duration ?? 0),
        errorMessage: asText(test.failureMessages?.[0] ?? "")
      })

      this.counters[file] += 1
    }
  }

  onRunComplete() {
    writeFileSync(this.output, JSON.stringify(this.rows, null, 2))
  }
}