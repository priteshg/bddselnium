stage('Generate Tally Report') {
  steps {
    script {
      def refreshFlag = params.RESET_TALLY ? "--refresh" : ""

      sh "node dist-tools/jestPlaywrightTally.js ${refreshFlag}"

      // New: generate JSONL files for Grafana
      sh '''
        set -e
        mkdir -p test-results

        # Playwright JSON report to JSONL
        node dist-tools/jsonl/playwright-to-jsonl.js test-results/playwright-report.json test-results/playwright-events.jsonl

        # Jest JSON to JSONL
        node dist-tools/jsonl/jest-to-jsonl.js jest-report.json test-results/jest-events.jsonl
      '''
    }
  }
}