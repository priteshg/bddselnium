stage('Generate Tally Report') {
  steps {
    script {
      def refreshFlag = params.RESET_TALLY ? "--refresh" : ""

      // Existing
      sh "node dist-tools/jestPlaywrightTally.js ${refreshFlag}"

      // New: JSONL for Grafana
      sh '''
        set -e
        mkdir -p test-results

        node dist-tools/jsonl/jestResultsToJsonl.js jest-report.json test-results/jest-events.jsonl
        node dist-tools/jsonl/playwright-to-jsonl.js test-results/playwright-report.json test-results/playwright-events.jsonl
      '''
    }
  }
  post {
    always {
      // Existing
      archiveArtifacts artifacts: 'test-stability-report.html', fingerprint: true
      archiveArtifacts artifacts: 'test-stability-history.json', fingerprint: true

      // New
      archiveArtifacts artifacts: 'test-results/jest-events.jsonl', fingerprint: true
      archiveArtifacts artifacts: 'test-results/playwright-events.jsonl', fingerprint: true
    }
  }
}




stage('Generate Metrics') {
  steps {
    script {
      sh '''
        set -e
        node dist-tools/metrics/jsonlToProm.js
      '''
    }
  }
}