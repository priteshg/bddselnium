const fs = require("fs");

// Load or initialise tally
let tally = {};
if (fs.existsSync("failure-tally.json")) {
  tally = JSON.parse(fs.readFileSync("failure-tally.json", "utf8"));
}

function addResult(testName, failed) {
  if (!tally[testName]) tally[testName] = { runs: 0, fails: 0 };
  tally[testName].runs++;
  if (failed) tally[testName].fails++;
}

// --- JEST (simple key:value format) ---
if (fs.existsSync("jest-results.json")) {
  const jest = JSON.parse(fs.readFileSync("jest-results.json", "utf8"));
  Object.entries(jest).forEach(([name, status]) => {
    addResult(name, status === "failed");
  });
}

// --- PLAYWRIGHT ---
if (fs.existsSync("playwright-report.json")) {
  const pw = JSON.parse(fs.readFileSync("playwright-report.json", "utf8"));

  function walk(suite) {
    suite.specs?.forEach(spec => {
      addResult(spec.title, !spec.ok);
    });
    suite.suites?.forEach(walk);
  }

  pw.suites?.forEach(walk);
}

// Save updated tally
fs.writeFileSync("failure-tally.json", JSON.stringify(tally, null, 2));

// Create human-readable file
let lines = [];
lines.push("Test Name                              Runs   Fails");
lines.push("------------------------------------------------------");

for (const [name, stats] of Object.entries(tally)) {
  lines.push(`${name.padEnd(38)} ${String(stats.runs).padEnd(6)} ${stats.fails}`);
}

fs.writeFileSync("tally-report.txt", lines.join("\n"));