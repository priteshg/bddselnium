// tools/jsonl/jestResultsToJsonl.ts
import fs from "fs"
import path from "path"
import crypto from "crypto"

type Status = "passed" | "failed" | "skipped" | "unknown"

type JestReportRow = {
  id: string
  name: string
  status: string
}

type JestJsonlEvent = {
  test_id: string
  tool: "jest"
  status: Status
  timestamp_utc: string
  test_name: string
  test_path: string
}

const DEFAULT_INPUT_PATH = "jest-report.json"
const DEFAULT_OUTPUT_PATH = "test-results/jest-events.jsonl"
const TEST_ID_HEX_LENGTH = 10

function ensureParentDir(filePath: string): void {
  fs.mkdirSync(path.dirname(filePath), { recursive: true })
}

function normalizeStatus(raw: string): Status {
  if (raw === "passed") return "passed"
  if (raw === "failed") return "failed"
  if (raw === "skipped") return "skipped"
  if (raw === "pending") return "skipped"
  if (raw === "disabled") return "skipped"
  if (raw === "todo") return "skipped"
  return "unknown"
}

function hashId(value: string): string {
  return crypto.createHash("sha256").update(value).digest("hex").slice(0, TEST_ID_HEX_LENGTH)
}

function parseId(id: string): { testPath: string; stableId: string } {
  const parts = id.split("::")
  const testPath = parts[0] || "unknown"
  const stableId = id || hashId(testPath)
  return { testPath, stableId }
}

function readReport(filePath: string): JestReportRow[] {
  const raw = fs.readFileSync(filePath, "utf8")
  const parsed = JSON.parse(raw) as unknown

  if (!Array.isArray(parsed)) {
    throw new Error("Expected jest-report.json to be a JSON array of { id, name, status }")
  }

  return parsed.map((row) => {
    const obj = row as Record<string, unknown>
    return {
      id: String(obj.id ?? ""),
      name: String(obj.name ?? ""),
      status: String(obj.status ?? ""),
    }
  })
}

function toJsonlEvents(rows: JestReportRow[], timestampUtc: string): JestJsonlEvent[] {
  return rows.map((row) => {
    const { testPath, stableId } = parseId(row.id)

    return {
      test_id: stableId || hashId(`${testPath}::${row.name}`),
      tool: "jest",
      status: normalizeStatus(row.status),
      timestamp_utc: timestampUtc,
      test_name: row.name,
      test_path: testPath,
    }
  })
}

function writeJsonl(outputPath: string, events: JestJsonlEvent[]): void {
  ensureParentDir(outputPath)
  const content = events.map((e) => JSON.stringify(e)).join("\n") + "\n"
  fs.writeFileSync(outputPath, content, "utf8")
}

function main(): void {
  const inputPath = process.argv[2] || DEFAULT_INPUT_PATH
  const outputPath = process.argv[3] || DEFAULT_OUTPUT_PATH

  const rows = readReport(inputPath)
  const events = toJsonlEvents(rows, new Date().toISOString())

  writeJsonl(outputPath, events)
}

main()